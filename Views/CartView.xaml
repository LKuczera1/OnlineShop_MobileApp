<?xml version="1.0" encoding="utf-8" ?>
<ContentView xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="OnlineShop_MobileApp.Views.CartView">

    <Grid RowDefinitions="85*,15*"
          BackgroundColor="{DynamicResource BackgroundColor}">

        <!-- User not logged in - View -->
        <Label Grid.Row="0"
               Text="Log in to use this feature"
               HorizontalOptions="Center"
               VerticalOptions="Center"
               FontSize="20">
            <Label.Triggers>
                <DataTrigger TargetType="Label"
                             Binding="{Binding IsCartViewAvailable}"
                             Value="True">
                    <Setter Property="IsVisible"
                            Value="False" />
                </DataTrigger>
            </Label.Triggers>
        </Label>

        <!-- List of cart items - When user is logged in -->
        <CollectionView Grid.Row="0"
                        ItemsSource="{Binding Items}"
                        IsVisible="{Binding IsCartViewAvailable}"
                        VerticalScrollBarVisibility="Never">
            <CollectionView.ItemTemplate>
                <DataTemplate>
                    <Grid>
                        <Border class="CollectionItemBorder"
                                Padding="0">

                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="8" />
                            </Border.StrokeShape>

                            <Grid RowDefinitions="Auto,Auto"
                                  RowSpacing="2"
                                  Padding="0"
                                  VerticalOptions="Center">
                                
                                <Grid Grid.Row="0"
                                      ColumnDefinitions="Auto,*"
                                      ColumnSpacing="5"
                                      Padding="5,0,5,0">

                                    <Border Grid.Column="0"
                                            WidthRequest="80"
                                            HeightRequest="80"
                                            Padding="0"
                                            StrokeThickness="0"
                                            BackgroundColor="Transparent"
                                            VerticalOptions="Start"
                                            Margin="0,6,0,0">
                                        <Border.StrokeShape>
                                            <RoundRectangle CornerRadius="6" />
                                        </Border.StrokeShape>

                                        <Border.Clip>
                                            <RoundRectangleGeometry CornerRadius="6"
                                                                    Rect="0,0,80,80" />
                                        </Border.Clip>

                                        <Image Source="{Binding product.ThumbnailSource}"
                                               Aspect="AspectFill"
                                               Background="White"/>
                                    </Border>

                                    <VerticalStackLayout Grid.Column="1"
                                                         Spacing="4"
                                                         VerticalOptions="Start">

                                        <Label Text="{Binding product.Name}"
                                               FontSize="20"
                                               LineBreakMode="TailTruncation" />

                                        <Label Text="{Binding product.Description}"
                                               FontSize="14"
                                               Opacity="0.8"
                                               LineBreakMode="WordWrap" />
                                    </VerticalStackLayout>
                                </Grid>

                                <Grid Grid.Row="1"
                                      ColumnDefinitions="Auto,*"
                                      ColumnSpacing="10"
                                      Padding="5,0,5,5">

                                    <VerticalStackLayout Grid.Column="1"
                                                         Spacing="6"
                                                         HorizontalOptions="End">

                                        <HorizontalStackLayout Spacing="8"
                                                               HorizontalOptions="End"
                                                               VerticalOptions="Center">

                                            <Button Text="-"
                                                    FontSize="30"
                                                    Padding="0,0,0,8"
                                                    WidthRequest="44"
                                                    HeightRequest="44"
                                                    HorizontalOptions="Center"
                                                    VerticalOptions="Start"
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type ContentView}},
                                          Path=BindingContext.DecreaseCommand}"
                                                    CommandParameter="{Binding .}" />

                                            <Border WidthRequest="44"
                                                    HeightRequest="44"
                                                    Padding="0"
                                                    BackgroundColor="{DynamicResource EntryColor}">
                                                <Label Text="{Binding Quantity}"
                                                       HorizontalOptions="Center"
                                                       VerticalOptions="Center" />
                                            </Border>

                                            <Button Text="+"
                                                    Padding="0,0,0,5"
                                                    FontSize="25"
                                                    WidthRequest="44"
                                                    HeightRequest="44"
                                                    HorizontalOptions="Center"
                                                    VerticalOptions="Center"
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type ContentView}},
                                          Path=BindingContext.IncreaseCommand}"
                                                    CommandParameter="{Binding .}" />

                                            <Button Text="U"
                                                    FontSize="22"
                                                    Padding="0,0,0,2"
                                                    WidthRequest="44"
                                                    HeightRequest="44"
                                                    HorizontalOptions="Center"
                                                    VerticalOptions="Center"
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type ContentView}},
                                          Path=BindingContext.RemoveCommand}"
                                                    CommandParameter="{Binding .}" />
                                        </HorizontalStackLayout>

                                        <Label FontSize="12"
                                               Opacity="0.8"
                                               HorizontalTextAlignment="End">
                                            <Label.FormattedText>
                                                <FormattedString>
                                                    <Span Text="Price per unit: " />
                                                    <Span Text="{Binding dto.Price, StringFormat='{0:0.00}'}" />
                                                </FormattedString>
                                            </Label.FormattedText>
                                        </Label>

                                        <Label FontSize="12"
                                               Opacity="0.8"
                                               HorizontalTextAlignment="End">
                                            <Label.FormattedText>
                                                <FormattedString>
                                                    <Span Text="Total price: " />
                                                    <Span Text="{Binding TotalPrice, StringFormat='{0:0.00}'}" />
                                                </FormattedString>
                                            </Label.FormattedText>
                                        </Label>

                                    </VerticalStackLayout>
                                </Grid>

                            </Grid>
                        </Border>
                    </Grid>
                </DataTemplate>


            </CollectionView.ItemTemplate>
        </CollectionView>

        <!-- Order summary -->
        <Border Grid.Row="1"
                Padding="5"
                Margin="0,5,0,0"
                IsVisible="{Binding IsCartViewAvailable}"
                BackgroundColor="{DynamicResource LowerBarColor}"
                MaximumHeightRequest="200"
                StrokeThickness="0">

            <Grid ColumnDefinitions="7*,3*"
                  Padding="2">
                <Grid RowDefinitions="Auto,Auto,Auto"
                      Grid.Column="0"
                      Padding="0"
                      RowSpacing="1">

                    <Label Text="Order summary:"
                           Grid.Row="0" 
                           FontSize="15"/>

                    <Label Grid.Row="1">
                        <Label.FormattedText>
                            <FormattedString>
                                <Span Text="Total price: " />
                                <Span Text="{Binding TotalPrice, StringFormat='{0:0.00}'}" />
                                <Span FontSize="15" />
                            </FormattedString>
                        </Label.FormattedText>
                    </Label>

                    <Label Text="Pay to send order request"
                           Grid.Row="2"
                           FontSize="15" />
                </Grid>

                <Button Grid.Column="1"
                        Text="Pay order"
                        Command="{Binding PlaceOrderCommand}" 
                        MaximumHeightRequest="60"
                        MaximumWidthRequest="140"
                        CornerRadius="5"/>
            </Grid>
        </Border>
    </Grid>
</ContentView>
